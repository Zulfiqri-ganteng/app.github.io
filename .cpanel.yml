---
deployment:
  tasks:
    # ğŸ”¹ 1. Tentukan path tujuan deploy
    - export DEPLOY_PATH=/home/sewx2253/public_html/app.sewaambulaneindonesia24jam.com
    - echo "ğŸš€ Memulai proses deploy otomatis"
    - echo "ğŸ“ Target: $DEPLOY_PATH"
    - echo "ğŸ“… Waktu: $(date)"

    # ğŸ”¹ 2. Pastikan folder tujuan ada
    - if [ ! -d "$DEPLOY_PATH" ]; then
      echo "ğŸ”§ Folder tujuan tidak ada. Membuat folder...";
      mkdir -p $DEPLOY_PATH;
      echo "âœ… Folder berhasil dibuat";
      else
      echo "âœ… Folder tujuan sudah ada.";
      fi

    # ğŸ”¹ 3. Hapus semua file lama (termasuk file tersembunyi)
    - echo "ğŸ§¹ Membersihkan file lama..."
    - /bin/rm -rf $DEPLOY_PATH/*
    - /bin/rm -rf $DEPLOY_PATH/.[^.]* 2>/dev/null || echo "â„¹ï¸ Tidak ada file tersembunyi (.htaccess, dll)"

    # ğŸ”¹ 4. Salin semua file dari repositori ke folder tujuan
    - echo "ğŸ“¦ Menyalin file baru ke $DEPLOY_PATH..."
    - /bin/cp -rf ./* $DEPLOY_PATH
    - /bin/cp -rf ./.[^.]* $DEPLOY_PATH 2>/dev/null || echo "â„¹ï¸ Tidak ada file tersembunyi untuk disalin"

    # ğŸ”¹ 5. Setel izin akses yang aman
    - echo "ğŸ” Mengatur izin file dan folder..."
    - /bin/chmod -R 644 $DEPLOY_PATH
    - /bin/chmod -R 755 $DEPLOY_PATH/application $DEPLOY_PATH/system $DEPLOY_PATH/vendor $DEPLOY_PATH/assets $DEPLOY_PATH/uploads 2>/dev/null || true
    - /bin/chmod 644 $DEPLOY_PATH/.htaccess 2>/dev/null || echo "â„¹ï¸ File .htaccess tidak ditemukan"
    - /bin/chmod 644 $DEPLOY_PATH/index.php 2>/dev/null || true

    # ğŸ”¹ 6. Pastikan folder uploads bisa ditulis (penting untuk upload gambar, dokumen, dll)
    - /bin/chmod -R 777 $DEPLOY_PATH/uploads 2>/dev/null || echo "âš ï¸ Peringatan: Folder uploads tidak ada atau tidak perlu writable"

    # ğŸ”¹ 7. Bersihkan cache CodeIgniter (opsional, tapi disarankan)
    - echo "ğŸ§¹ Membersihkan cache dan log lama..."
    - /bin/rm -rf $DEPLOY_PATH/application/cache/*
    - /bin/rm -rf $DEPLOY_PATH/application/logs/log-*.php 2>/dev/null || echo "â„¹ï¸ Tidak ada log lama"

    # ğŸ”¹ 8. Selesai! Notifikasi sukses
    - echo "âœ… DEPLOY BERHASIL!"
    - echo "ğŸ”— Buka website: https://app.sewaambulaneindonesia24jam.com"
    - echo "âœ¨ Selamat! Website telah diperbarui secara otomatis."
    - echo "ğŸ”š Proses selesai pada: $(date)"
